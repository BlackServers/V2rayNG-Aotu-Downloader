<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>دانلود آخرین نسخه v2rayNG</title>

  <!-- فونت -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#4f46e5;
      --primary-hover:#4338ca;
      --bg:#0f1115;
      --card:#1e1e2f;
      --muted:#a5acc7;
      --danger:#ef4444;
      --radius:12px;
      --shadow: 0 10px 15px -3px rgba(0,0,0,0.7), 0 4px 6px -2px rgba(0,0,0,0.5);
      color-scheme: dark;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Vazirmatn",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#fff;
      padding:2rem 1rem;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:760px;
      margin:0 auto;
    }

    .logo-container{
      background:#222;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:1rem;
      text-align:center;
      margin-bottom:1.25rem;
    }
    .logo-container img{max-width:160px;height:auto;object-fit:contain;filter:drop-shadow(0 0 4px var(--primary));}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .card-header{
      padding:1.25rem;
      text-align:center;
      border-bottom:1px solid #33334d;
    }
    .card-header h1{color:var(--primary);font-size:1.4rem;display:flex;align-items:center;justify-content:center;gap:.5rem}
    .card-body{padding:1.6rem;direction:rtl}
    .card-footer{padding:1rem 1.25rem;background:#222233;color:var(--muted);font-size:.9rem;border-top:1px solid #33334d;text-align:center}

    .version-badge{
      display:inline-flex;align-items:center;gap:.5rem;
      background:#2a2a42;color:var(--primary);padding:.45rem 1rem;border-radius:9999px;
      font-weight:600;border:1px solid #444466;margin-bottom:1rem;
    }

    .download-btn{
      display:inline-flex;align-items:center;justify-content:center;
      gap:.5rem;width:100%;max-width:360px;margin:0 auto 0.8rem;padding:.85rem 1.25rem;
      background:var(--primary);color:#fff;border-radius:9999px;border:none;
      font-weight:700;cursor:pointer;text-decoration:none;
      transition:all .18s ease;box-shadow:none;
    }
    .download-btn:hover{transform:translateY(-2px);background:var(--primary-hover)}

    .countdown{color:var(--muted);font-size:.95rem;text-align:center;margin-bottom:1rem;display:flex;align-items:center;justify-content:center;gap:.4rem}
    .countdown span{color:var(--danger);font-weight:700;min-width:28px;text-align:center}

    .dropdown{position:relative;margin:1rem 0}
    .dropdown-btn{
      width:100%;padding:.85rem 1rem;border-radius:8px;background:#2a2a42;color:var(--primary);
      border:1px solid var(--primary);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;
    }
    .dropdown-content{
      display:none;position:absolute;left:0;right:0;margin-top:.5rem;background:#1e1e2f;border-radius:var(--radius);
      max-height:320px;overflow:auto;border:1px solid #33334d;z-index:40;direction:rtl;
    }
    .dropdown-content.show{display:block}
    .dropdown-content a{display:block;padding:.75rem 1rem;color:#fff;text-decoration:none;border-bottom:1px solid #33334d}
    .dropdown-content a:hover{background:var(--primary);color:#fff}

    .accordion{margin-top:1rem;border-radius:var(--radius);overflow:hidden;background:#2a2a42}
    .accordion-item{border-bottom:1px solid #33334d}
    .accordion-header{padding:1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .accordion-title{font-weight:700;color:var(--primary);display:flex;gap:.5rem;align-items:center}
    .accordion-icon{transition:transform .25s}
    .accordion-item.active .accordion-icon{transform:rotate(180deg)}
    .accordion-content{max-height:0;overflow:hidden;transition:max-height .3s ease,padding .25s ease;padding:0 1.25rem;color:var(--muted);white-space:pre-wrap}
    .accordion-item.active .accordion-content{padding:1rem 1.25rem;max-height:600px}

    .alert{padding:1rem;border-radius:10px;margin-bottom:1rem}
    .alert-danger{background:#4f1b1b;color:#fca5a5;border:1px solid #fca5a5}
    .alert-success{background:#064e3b;color:#a7f3d0;border:1px solid #6ee7b7}

    @media (max-width:560px){
      .card-body{padding:1rem}
      .download-btn{max-width:100%}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo-container">
      <img src="your-logo.png" alt="لوگو" id="logo" />
    </div>

    <div class="card" role="main" aria-labelledby="pageTitle">
      <div class="card-header">
        <h1 id="pageTitle"><i class="fas fa-rocket"></i> دانلود آخرین نسخه v2rayNG</h1>
      </div>

      <div class="card-body" id="content">
        <div class="loading" id="loading">
          <div class="spinner" style="width:40px;height:40px;border:3px solid rgba(79,70,229,0.18);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem"></div>
          <p style="text-align:center;color:var(--muted)">در حال دریافت اطلاعات از GitHub...</p>
        </div>
      </div>

      <div class="card-footer">
        نوشته شده توسط
        <a href="https://t.me/blackservers" target="_blank" rel="noopener">Black Servers</a>
        — این صفحه آخرین نسخه را از
        <a href="https://github.com/2dust/v2rayNG/releases" target="_blank" rel="noopener">صفحه ریلیزهای GitHub</a> می‌گیرد.
      </div>
    </div>
  </div>

<script>
/* ========= پیکربندی ========= */
const GITHUB_API = "https://api.github.com/repos/2dust/v2rayNG/releases";
const START_TIMER_SECONDS = 10; // مقدار تایمر اولیه (۱۰ ثانیه)
let stableReleases = []; // نسخه‌های پایدار و منحصربفرد
let latestTag = "";
let latestDownloadUrl = "";
let selectedTag = "";
let selectedDownloadUrl = "";
let selectedNotes = "";
let arch = detectArch();

/* تایمر */
let intervalId = null;
let timeLeft = START_TIMER_SECONDS;
let downloadClicked = false;

/* ====== توابع کمکی ====== */
function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function getUrlParameter(name) {
  name = name.replace(/[\[\]]/g, "\\$&");
  const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
  const results = regex.exec(window.location.href);
  if (!results) return null;
  if (!results[2]) return "";
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function detectArch() {
  const ua = navigator.userAgent.toLowerCase();
  if (ua.includes("aarch64") || ua.includes("arm64")) return "arm64";
  if (ua.includes("armv7") || ua.includes("armv7l")) return "armv7";
  if (ua.includes("arm")) return "arm";
  if (ua.includes("x86_64") || ua.includes("wow64")) return "x86_64";
  if (ua.includes("x86") || ua.includes("i686") || ua.includes("intel")) return "x86";
  return "universal";
}

function cleanVersion(tag) {
  return tag.replace(/^v/i, "").split("-")[0];
}

function findBestAssetForRelease(release, archHint) {
  if (!release || !release.assets) return null;
  const assets = release.assets;
  const n = (a) => (a && a.name ? a.name.toLowerCase() : "");

  // اول سعی کن به صورت دقیق نام معماری در نام فایل بیاد
  let primary = assets.find(a => n(a).includes(archHint) && n(a).endsWith(".apk"));
  if (primary) return primary;

  // بعد دنبال نام‌های معمول بگرد
  const candidates = ["universal.apk","all.apk","android.apk","arm64.apk","armv7.apk","armeabi-v7a","armeabi.apk"];
  for (const c of candidates) {
    const found = assets.find(a => n(a).includes(c));
    if (found) return found;
  }

  // fallback به اولین apk
  const anyApk = assets.find(a => n(a).endsWith(".apk"));
  if (anyApk) return anyApk;

  return null;
}

/* ======= UI render و منطق ======= */
function showLoading() {
  const content = document.getElementById("content");
  content.innerHTML = `
    <div class="loading" id="loading">
      <div class="spinner" style="width:40px;height:40px;border:3px solid rgba(79,70,229,0.18);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem"></div>
      <p style="text-align:center;color:var(--muted)">در حال دریافت اطلاعات از GitHub...</p>
    </div>
  `;
}

function renderUI() {
  const content = document.getElementById("content");
  content.innerHTML = `
    <div style="text-align:center;margin-bottom:1rem;">
      <div class="version-badge" id="versionBadge"><i class="fas fa-tag"></i> نسخه ${escapeHtml(latestTag)}</div>
    </div>

    <div style="text-align:center;margin-bottom:.5rem;">
      <a id="downloadBtn" class="download-btn" href="${latestDownloadUrl || "#"}" download>
        <i class="fas fa-download"></i>&nbsp; دانلود مستقیم نسخه ${escapeHtml(latestTag)}
      </a>
    </div>

    <div class="countdown" id="countdown">
      دانلود بعد از <span id="timer">${timeLeft}</span> ثانیه فعال می‌شود.
    </div>

    <div class="dropdown" aria-hidden="false">
      <button class="dropdown-btn" id="dropdownBtn" aria-haspopup="true" aria-expanded="false"> <i class="fas fa-angle-down"></i> انتخاب نسخه دیگر</button>
      <div class="dropdown-content" id="dropdownMenu" role="menu" aria-label="لیست نسخه‌ها"></div>
    </div>

    <div class="accordion" id="accordion">
      <div class="accordion-item" id="accordionItem">
        <div class="accordion-header" id="accordionHeader" role="button" aria-expanded="false" tabindex="0">
          <span class="accordion-title"><i class="fas fa-clipboard-list"></i> مشاهده تغییرات نسخه ${escapeHtml(latestTag)}</span>
          <i class="fas fa-chevron-down accordion-icon" aria-hidden="true"></i>
        </div>
        <div class="accordion-content" id="accordionContent" role="region" aria-labelledby="accordionHeader">
          ${escapeHtml(selectedNotes || "")}
        </div>
      </div>
    </div>
  `;

  // populate dropdown items
  const dropdownMenu = document.getElementById("dropdownMenu");
  dropdownMenu.innerHTML = ""; // پاکسازی
  for (const rel of stableReleases) {
    const tag = rel.tag_name;
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = tag;
    a.dataset.tag = tag;
    a.addEventListener("click", (e) => { e.preventDefault(); onSelectVersion(tag); });
    dropdownMenu.appendChild(a);
  }

  // dropdown toggle
  const dropdownBtn = document.getElementById("dropdownBtn");
  const dropdown = document.getElementById("dropdownMenu");
  dropdownBtn.addEventListener("click", (ev) => {
    ev.stopPropagation();
    const shown = dropdown.classList.toggle("show");
    dropdownBtn.setAttribute("aria-expanded", shown ? "true" : "false");
  });

  // close dropdown on outside click
  document.addEventListener("click", (e) => {
    if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.remove("show");
      dropdownBtn.setAttribute("aria-expanded", "false");
    }
  });

  // download button behavior: set clicked flag then navigate
  const dlBtn = document.getElementById("downloadBtn");
  dlBtn.addEventListener("click", (e) => {
    // اگر لینک معتبر نباشه هشدار بده
    if (!dlBtn.href || dlBtn.href === "#" || dlBtn.href.trim() === "") {
      e.preventDefault();
      alert("فایل دانلود برای این نسخه یافت نشد.");
      return;
    }
    downloadClicked = true;
    // اجازه بده مرورگر دانلود/ناوبری رو انجام بده؛ برای اطمینان از عملکرد هم می‌تونیم بعد از یک تاخیر ناچیز redirect کنیم
    setTimeout(() => { window.location.href = dlBtn.href; }, 10);
  });

  // accordion initial state: closed
  const accHeader = document.getElementById("accordionHeader");
  const accItem = document.getElementById("accordionItem");
  const accContent = document.getElementById("accordionContent");

  if (accItem) accItem.classList.remove("active");
  if (accHeader) accHeader.setAttribute("aria-expanded", "false");
  if (accContent) { accContent.style.maxHeight = "0"; accContent.style.padding = "0 1.25rem"; }

  accHeader.addEventListener("click", () => {
    const expanded = accHeader.getAttribute("aria-expanded") === "true";
    if (expanded) {
      accItem.classList.remove("active");
      accHeader.setAttribute("aria-expanded", "false");
      accContent.style.maxHeight = "0";
      accContent.style.padding = "0 1.25rem";
    } else {
      accItem.classList.add("active");
      accHeader.setAttribute("aria-expanded", "true");
      accContent.style.padding = "1rem 1.25rem";
      accContent.style.maxHeight = accContent.scrollHeight + "px";
    }
  });
  accHeader.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); accHeader.click(); }
  });

  // update references for timer control
  // شروع/ری‌استارت تایمر
  startCountdown(START_TIMER_SECONDS);
}

/* ======= تایمر ======= */
function startCountdown(seconds) {
  // clear قبلی
  clearInterval(intervalId);
  timeLeft = typeof seconds === "number" ? seconds : START_TIMER_SECONDS;
  downloadClicked = false; // هر بار که تایمر ریست میشه فرض می‌کنیم کاربر هنوز دانلود نزده

  const timerSpan = document.getElementById("timer");
  const countdownEl = document.getElementById("countdown");
  if (!timerSpan || !countdownEl) return;

  timerSpan.textContent = String(timeLeft);

  intervalId = setInterval(() => {
    timeLeft--;
    if (timeLeft < 0) timeLeft = 0;
    timerSpan.textContent = String(timeLeft);

    if (timeLeft === 0) {
      clearInterval(intervalId);
      // متن رو به "دانلود فعال است." تغییر بده ولی span رو نگه دار
      countdownEl.textContent = "دانلود فعال است.";
      // اگر کاربر کلیک نکرده بود، دانلود خودکار انجام شود
      if (!downloadClicked) {
        const target = selectedDownloadUrl || latestDownloadUrl;
        if (target && target !== "#") {
          downloadClicked = true; // برای جلوگیری از دوبار اجرا
          // انجام دانلود
          window.location.href = target;
        } else {
          // اگر لینک موجود نبود، به کاربر اطلاع بده
          console.warn("هیچ لینک دانلود معتبری برای دانلود خودکار یافت نشد.");
        }
      }
    }
  }, 1000);
}

/* ======= وقتی کاربر نسخه‌ای انتخاب می‌کند ======= */
function onSelectVersion(tag) {
  const rel = stableReleases.find(r => r.tag_name === tag);
  if (!rel) return;

  const chosenAsset = findBestAssetForRelease(rel, arch) || findBestAssetForRelease(rel, "universal");
  if (!chosenAsset) {
    alert(`فایل مناسب برای نسخه ${tag} یافت نشد.`);
    return;
  }

  selectedTag = tag;
  selectedDownloadUrl = chosenAsset.browser_download_url;
  selectedNotes = rel.body || "";

  // آپدیت دکمه دانلود
  const dlBtn = document.getElementById("downloadBtn");
  if (dlBtn) {
    dlBtn.href = selectedDownloadUrl;
    dlBtn.innerHTML = `<i class="fas fa-download"></i>&nbsp; دانلود مستقیم نسخه ${escapeHtml(selectedTag)}`;
  }

  // آپدیت نشان نسخه
  const vb = document.getElementById("versionBadge");
  if (vb) vb.innerHTML = `<i class="fas fa-tag"></i> نسخه ${escapeHtml(selectedTag)}`;

  // آپدیت آکاردئون: تیتر و متن
  const accTitle = document.querySelector(".accordion-header .accordion-title");
  const accContent = document.getElementById("accordionContent");
  if (accTitle) accTitle.innerHTML = `<i class="fas fa-clipboard-list"></i> مشاهده تغییرات نسخه ${escapeHtml(selectedTag)}`;
  if (accContent) {
    accContent.textContent = selectedNotes || "توضیحاتی وجود ندارد.";
    // اگر آکاردئون باز است، بازنشانی maxHeight
    const parentItem = document.getElementById("accordionItem");
    if (parentItem && parentItem.classList.contains("active")) {
      accContent.style.maxHeight = accContent.scrollHeight + "px";
    }
  }

  // بستن dropdown
  const dropdownMenu = document.getElementById("dropdownMenu");
  const dropdownBtn = document.getElementById("dropdownBtn");
  if (dropdownMenu) dropdownMenu.classList.remove("show");
  if (dropdownBtn) dropdownBtn.setAttribute("aria-expanded", "false");

  // ریست تایمر به مقدار اولیه (بدون حذف span یا متن کلی)
  const timerSpan = document.getElementById("timer");
  const countdownEl = document.getElementById("countdown");
  if (timerSpan && countdownEl) {
    // فقط مقدار عددی داخل span را بروزرسانی کن
    timerSpan.textContent = String(START_TIMER_SECONDS);
    // بازنویسی متن countdown به شکل استاندارد (حفظ span)
    countdownEl.innerHTML = `دانلود بعد از <span id="timer">${START_TIMER_SECONDS}</span> ثانیه فعال می‌شود.`;
  }

  // ری‌استارت تایمر
  startCountdown(START_TIMER_SECONDS);
}

/* ======= فراخوانی GitHub و آماده‌سازی داده‌ها ======= */
async function fetchReleases() {
  showLoading();
  try {
    const res = await fetch(GITHUB_API);
    if (!res.ok) throw new Error("خطا در دریافت اطلاعات از GitHub");
    const releases = await res.json();
    if (!releases || releases.length === 0) throw new Error("هیچ ریلیزی یافت نشد");

    // فیلتر نسخه‌های پایدار و یونیک (حذف pre-release و تکراری)
    const seen = new Set();
    stableReleases = [];
    for (const r of releases) {
      if (r.prerelease) continue;
      const key = cleanVersion(r.tag_name);
      if (seen.has(key)) continue;
      seen.add(key);
      stableReleases.push(r);
    }

    if (stableReleases.length === 0) throw new Error("هیچ نسخهٔ پایدار یافت نشد");

    // آخرین ریلیز را انتخاب کن
    const latest = stableReleases[0];
    latestTag = latest.tag_name;
    const primaryAsset = findBestAssetForRelease(latest, arch) || findBestAssetForRelease(latest, "universal");
    latestDownloadUrl = primaryAsset ? primaryAsset.browser_download_url : "";
    selectedTag = latestTag;
    selectedDownloadUrl = latestDownloadUrl;
    selectedNotes = latest.body || "";

    // اگر query param version وجود داشت سعی کن همان را انتخاب کنی
    const requestedVersion = getUrlParameter("version");
    if (requestedVersion) {
      const found = stableReleases.find(r => r.tag_name.includes(requestedVersion));
      if (found) {
        const asset = findBestAssetForRelease(found, arch) || findBestAssetForRelease(found, "universal");
        if (asset) {
          selectedTag = found.tag_name;
          selectedDownloadUrl = asset.browser_download_url;
          selectedNotes = found.body || "";
        } else {
          // اگر برای نسخهٔ درخواست شده asset مناسب نبود، پیغام کوتاه نشان بده
          // اما به هر حال به UI ادامه بده با آخرین نسخه
          console.warn("نسخه درخواستی یافت شد اما فایل apk مناسب نبود.");
        }
      } else {
        console.warn("نسخه درخواستی در میان ریلیزها یافت نشد.");
      }
    }

    // اکنون UI را رندر کن
    renderUI();

  } catch (err) {
    const content = document.getElementById("content");
    content.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i>&nbsp; ${escapeHtml(err.message || "خطای نامشخص")}
      </div>
    `;
    console.error(err);
  }
}

/* ======= شروع کار صفحه ======= */
document.addEventListener("DOMContentLoaded", () => {
  // ابتدا fetch ریلیزها
  fetchReleases();
  // نکته: تایمر واقعی و شروع آن پس از renderUI() آغاز می‌شود
});

/* ======= ایمنی: جلوگیری از رفتار ناخواسته هنگام unload ======= */
window.addEventListener("beforeunload", () => {
  clearInterval(intervalId);
});
</script>
</body>
</html>
